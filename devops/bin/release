#!/bin/bash

# This binary builds a version (production, staging, pull-requests, etc)
# and publishes it to docker hub.

if ! [[ -n "${DOCKER_USERNAME}" && -n "${DOCKER_PASSWORD}" && -n "${DOCKER_EMAIL}" ]]; then
    echo "ERROR - DOCKER_USERNAME and DOCKER_PASSWORD and DOCKER_EMAIL variables should exist for deployment."
    exit 1
fi

if [ ! ${RELEASE_TAG} ]; then
    echo "ERROR - RELEASE_TAG env is not set for deployment (e.g '0.3', 'pull-57')."
    exit 1
fi

if [ ! ${RELEASE_PHASE} ]; then
    echo "ERROR - RELEASE_PHASE env is not set for deployment. (e.g. production, staging)"
    exit 1
fi

sudo git clean -xdf
sudo rm -Rf vendor/

export CLEAN_BUILD=1
bin/build

touch Dockerfile
echo "FROM ravaj/${RELEASE_PHASE}-web:${RELEASE_TAG}" >> Dockerfile
echo "ADD . /var/www" >> Dockerfile

docker build -t ravaj/${RELEASE_PHASE}-web:${RELEASE_TAG} ./devops/web
docker build -t ravaj/${RELEASE_PHASE}:${RELEASE_TAG} .
docker login --username=${DOCKER_USERNAME} --password=${DOCKER_PASSWORD} --email=${DOCKER_EMAIL}
docker push ravaj/${RELEASE_PHASE}:${RELEASE_TAG}
docker tag -f ravaj/${RELEASE_PHASE}:${RELEASE_TAG} ravaj/${RELEASE_PHASE}:latest
docker push ravaj/${RELEASE_PHASE}:latest